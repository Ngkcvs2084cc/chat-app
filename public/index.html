<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂåøÂêçËÅäÂ§©Á≥ªÁªü</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <script src="config.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ÂìçÂ∫îÂºèÂÆπÂô® */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
            min-height: 100vh;
        }
        
        @media (min-width: 768px) {
            .app-container { padding: 20px; }
        }
        
        /* HeaderÂìçÂ∫îÂºè */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        @media (min-width: 768px) {
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 20px 30px;
                margin-bottom: 20px;
                border-radius: 20px;
            }
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        @media (min-width: 768px) {
            .logo { font-size: 24px; gap: 10px; }
        }
        
        .connection-status {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        @media (min-width: 768px) {
            .connection-status { padding: 5px 12px; border-radius: 20px; font-size: 12px; }
        }
        
        .connection-status.connected { background: #d4edda; color: #155724; }
        .connection-status.disconnected { background: #f8d7da; color: #721c24; }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        @media (min-width: 768px) {
            .header-right { gap: 15px; }
        }
        
        .user-info-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 15px;
            flex: 1;
            min-width: 0;
        }
        
        @media (min-width: 768px) {
            .user-info-card {
                padding: 10px 16px;
                border-radius: 20px;
                flex: initial;
            }
        }
        
        .user-avatar-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #667eea;
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) {
            .user-avatar-img { width: 45px; height: 45px; }
        }
        
        .user-info-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }
        
        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        @media (min-width: 768px) {
            .user-name { font-size: 15px; }
        }
        
        .user-meta {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
        }
        
        @media (min-width: 768px) {
            .user-meta { gap: 8px; font-size: 12px; }
        }
        
        .gender-male { color: #4A90E2; }
        .gender-female { color: #FF69B4; }
        
        .temp-badge {
            background: #ffc107;
            color: #856404;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
        }
        
        @media (min-width: 768px) {
            .temp-badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        }
        
        .coins-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        @media (min-width: 768px) {
            .coins-badge {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 14px;
                gap: 5px;
            }
        }
        
        .coins-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        @media (min-width: 768px) {
            .btn {
                padding: 10px 20px;
                border-radius: 10px;
                font-size: 14px;
                gap: 8px;
            }
        }
        
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        
        /* ‰∏ªÂÜÖÂÆπÂå∫Âüü - ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄÂÖ≥ÈîÆ */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: calc(100vh - 140px);
        }
        
        @media (min-width: 768px) {
            .main-content {
                display: grid;
                grid-template-columns: 300px 1fr;
                gap: 20px;
                height: calc(100vh - 140px);
            }
        }
        
        /* ËÅäÂ§©Âå∫Âüü */
        .chat-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            height: 60vh;
            order: 2;  /* ÊâãÊú∫Á´ØÁ¨¨‰∫å‰∏™Ôºà‰∏ãÊñπÔºâ */
        }
        
        @media (min-width: 768px) {
            .chat-area {
                border-radius: 20px;
                height: 100%;
                order: 2;  /* ÁîµËÑëÁ´ØÁ¨¨‰∫å‰∏™ÔºàÂè≥ËæπÔºâ */
            }
        }
        
        /* ‰æßËæπÊ†èÔºàÁî®Êà∑ÂàóË°®Ôºâ- ÂÖ≥ÈîÆ‰øÆÊîπ */
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 12px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            height: 35vh;  /* ÊâãÊú∫Á´ØÊõ¥Á¥ßÂáë */
            order: 1;  /* ÊâãÊú∫Á´ØÁ¨¨‰∏Ä‰∏™Ôºà‰∏äÊñπÔºâ */
        }
        
        @media (min-width: 768px) {
            .sidebar {
                border-radius: 20px;
                padding: 20px;
                height: 100%;
                order: 1;  /* ÁîµËÑëÁ´ØÁ¨¨‰∏Ä‰∏™ÔºàÂ∑¶ËæπÔºâ */
            }
        }
        
        .sidebar-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        @media (min-width: 768px) {
            .sidebar-title { 
                font-size: 16px; 
                margin-bottom: 15px; 
                gap: 8px;
            }
        }
        
        /* Áî®Êà∑ÁΩëÊ†º - Á¥ßÂáëÂûã */
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
        }
        
        @media (min-width: 768px) {
            .user-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
        
        /* Áî®Êà∑Âç°Áâá - Á¥ßÂáëÂúÜÂΩ¢Â§¥ÂÉè */
        .user-card {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            min-height: auto;
        }
        
        @media (min-width: 768px) {
            .user-card {
                flex-direction: row;
                text-align: left;
                padding: 10px;
                gap: 10px;
            }
        }
        
        .user-card:active { transform: scale(0.95); }
        
        @media (min-width: 768px) {
            .user-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }
        }
        
        .user-card.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .user-card-avatar-wrapper {
            position: relative;
            margin-bottom: 4px;
        }
        
        @media (min-width: 768px) {
            .user-card-avatar-wrapper {
                margin-bottom: 0;
                flex-shrink: 0;
            }
        }
        
        /* Â§¥ÂÉè - Êõ¥Â∞èÊõ¥Á¥ßÂáë */
        .user-card-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid #ddd;
            object-fit: cover;
        }
        
        @media (min-width: 768px) {
            .user-card-avatar { 
                width: 40px; 
                height: 40px; 
            }
        }
        
        .online-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            position: absolute;
            bottom: 0;
            right: 0;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        @media (min-width: 768px) {
            .online-dot { width: 10px; height: 10px; }
        }
        
        /* Êú™ËØªÁ∫¢ÁÇπ - Êõ¥Â∞èÈÄÇÈÖç */
        .unread-badge {
            position: absolute !important;
            top: -4px !important;
            right: -4px !important;
            min-width: 16px !important;
            height: 16px !important;
            padding: 0 4px !important;
            border-radius: 8px !important;
            background: #dc3545 !important;
            color: white !important;
            font-size: 9px !important;
            font-weight: 700 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            animation: blink 1s infinite !important;
            border: 2px solid white !important;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.5) !important;
            z-index: 10 !important;
        }
        
        @media (min-width: 768px) {
            .unread-badge {
                min-width: 18px !important;
                height: 18px !important;
                padding: 0 4px !important;
                border-radius: 9px !important;
                font-size: 10px !important;
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; transform: scale(1); }
            25%, 75% { opacity: 0.7; transform: scale(1.1); }
        }
        
        .user-card-info {
            flex: 1;
            min-width: 0;
        }
        
        /* Áî®Êà∑Âêç - Êõ¥Â∞èÊõ¥Á¥ßÂáë */
        .user-card-name {
            font-weight: 600;
            font-size: 10px;
            margin-bottom: 2px;
            word-break: break-word;
            line-height: 1.2;
        }
        
        @media (min-width: 768px) {
            .user-card-name { 
                font-size: 12px; 
                margin-bottom: 3px; 
            }
        }
        
        .user-card-meta {
            font-size: 9px;
            opacity: 0.8;
            line-height: 1.2;
        }
        
        @media (min-width: 768px) {
            .user-card-meta { font-size: 10px; }
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 2px solid #f0f0f0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        @media (min-width: 768px) {
            .chat-header { padding: 20px; }
        }
        
        .chat-header h2 { font-size: 16px; }
        
        @media (min-width: 768px) {
            .chat-header h2 { font-size: 20px; }
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (min-width: 768px) {
            .chat-messages { padding: 20px; gap: 15px; }
        }
        
        .message {
            display: flex;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }
        
        @media (min-width: 768px) {
            .message { gap: 12px; }
        }
        
        .message.own { flex-direction: row-reverse; }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-avatar-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #ddd;
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) {
            .message-avatar-img { width: 40px; height: 40px; }
        }
        
        .message-content { max-width: 75%; }
        
        @media (min-width: 768px) {
            .message-content { max-width: 60%; }
        }
        
        .message-bubble {
            padding: 10px 14px;
            border-radius: 12px;
            background: #f8f9fa;
            word-wrap: break-word;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        @media (min-width: 768px) {
            .message-bubble {
                padding: 12px 16px;
                border-radius: 15px;
                margin-bottom: 5px;
                font-size: 15px;
            }
        }
        
        .message.own .message-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .message-time {
            font-size: 11px;
            color: #6c757d;
            padding: 0 5px;
        }
        
        @media (min-width: 768px) {
            .message-time { font-size: 12px; }
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 15px;
            width: fit-content;
            font-size: 12px;
            color: #6c757d;
        }
        
        @media (min-width: 768px) {
            .typing-indicator { padding: 10px; border-radius: 20px; font-size: 14px; }
        }
        
        .typing-dots { display: flex; gap: 3px; }
        
        .typing-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #6c757d;
            animation: typing 1.4s infinite;
        }
        
        @media (min-width: 768px) {
            .typing-dot { width: 6px; height: 6px; }
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        
        @media (min-width: 768px) {
            @keyframes typing {
                0%, 60%, 100% { transform: translateY(0); }
                30% { transform: translateY(-10px); }
            }
        }
        
        .chat-input-container {
            padding: 15px;
            border-top: 2px solid #f0f0f0;
            background: #fafafa;
        }
        
        @media (min-width: 768px) {
            .chat-input-container { padding: 20px; }
        }
        
        .message-limit-info {
            margin-bottom: 8px;
            padding: 8px;
            background: #fff3cd;
            border-radius: 6px;
            font-size: 11px;
            color: #856404;
        }
        
        @media (min-width: 768px) {
            .message-limit-info { margin-bottom: 10px; padding: 10px; border-radius: 8px; font-size: 13px; }
        }
        
        .chat-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        @media (min-width: 768px) {
            .chat-input-wrapper { gap: 10px; }
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        
        @media (min-width: 768px) {
            .chat-input { padding: 12px 20px; border-radius: 25px; font-size: 15px; }
        }
        
        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) {
            .send-btn { width: 45px; height: 45px; }
        }
        
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .send-btn:active:not(:disabled) { transform: scale(0.9); }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            gap: 12px;
            padding: 20px;
        }
        
        @media (min-width: 768px) {
            .empty-state { gap: 15px; }
        }
        
        /* Ê®°ÊÄÅÊ°ÜÂìçÂ∫îÂºè */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (min-width: 768px) {
            .modal { border-radius: 20px; padding: 30px; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        @media (min-width: 768px) {
            .modal-header { margin-bottom: 20px; }
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        @media (min-width: 768px) {
            .modal-title { font-size: 24px; }
        }
        
        .close-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: #f8f9fa;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) {
            .close-btn { width: 32px; height: 32px; }
        }
        
        .form-group { margin-bottom: 15px; }
        
        @media (min-width: 768px) {
            .form-group { margin-bottom: 20px; }
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        
        @media (min-width: 768px) {
            .form-label { margin-bottom: 8px; font-size: 14px; }
        }
        
        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        
        @media (min-width: 768px) {
            .form-input { padding: 12px 16px; border-radius: 10px; font-size: 15px; }
        }
        
        .form-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 12px;
            font-size: 12px;
            color: #856404;
        }
        
        @media (min-width: 768px) {
            .form-warning { border-radius: 10px; padding: 12px; margin-bottom: 15px; font-size: 14px; }
        }
        
        .coin-packages {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        @media (min-width: 768px) {
            .coin-packages { gap: 15px; }
        }
        
        .coin-package {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        @media (min-width: 768px) {
            .coin-package { padding: 20px; border-radius: 15px; }
        }
        
        .coin-package:active { transform: scale(0.98); }
        
        @media (min-width: 768px) {
            .coin-package:hover {
                border-color: #667eea;
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
            }
        }
        
        .coin-package-info { display: flex; align-items: center; gap: 12px; }
        
        @media (min-width: 768px) {
            .coin-package-info { gap: 15px; }
        }
        
        .coin-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        @media (min-width: 768px) {
            .coin-icon { width: 50px; height: 50px; font-size: 24px; }
        }
        
        .coin-details h3 {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }
        
        @media (min-width: 768px) {
            .coin-details h3 { font-size: 20px; margin-bottom: 5px; }
        }
        
        .coin-details p { font-size: 12px; color: #6c757d; }
        
        @media (min-width: 768px) {
            .coin-details p { font-size: 14px; }
        }
        
        .coin-price {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        @media (min-width: 768px) {
            .coin-price { font-size: 28px; }
        }
        
        /* Ëß¶Êë∏‰ºòÂåñ */
        @media (hover: none) {
            .btn, .user-card, .coin-package {
                -webkit-tap-highlight-color: transparent;
            }
        }
        
        /* ÊªöÂä®Êù°Ê†∑Âºè */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // ==================== SupabaseÈÖçÁΩÆ ====================
        const SUPABASE_URL = window.SUPABASE_CONFIG?.url || 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = window.SUPABASE_CONFIG?.anonKey || 'YOUR_SUPABASE_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // SupabaseÈÄÇÈÖçÂô®ÔºàÁÆÄÂåñÁâàÔºåÂÜÖËÅîÔºâ
        const db = {
            async loginUser(username, password, location) {
                const { data, error } = await supabase.rpc('login_user', {
                    p_username: username, p_password: password, p_location: location
                });
                return error ? { success: false, error: error.message } : data;
            },
            async registerUser(username, password, tempId, gender, avatarUrl, location, sentCounts) {
                const { data, error } = await supabase.rpc('register_user', {
                    p_username: username, p_password: password, p_temp_id: tempId,
                    p_gender: gender, p_avatar_url: avatarUrl, p_location: location,
                    p_sent_counts: sentCounts || {}
                });
                return error ? { success: false, error: error.message } : data;
            },
            async sendMessage(senderId, receiverId, text, isTemp) {
                const { data, error } = await supabase.rpc('send_message_with_limits', {
                    p_sender_id: senderId, p_receiver_id: receiverId, 
                    p_text: text, p_is_temp: isTemp
                });
                return error ? { success: false, error: error.message } : data;
            },
            async rechargeCoins(userId, orderId, coins, amount) {
                const { data, error } = await supabase.rpc('recharge_coins', {
                    p_user_id: userId, p_order_id: orderId, 
                    p_coins: coins, p_amount: amount
                });
                return error ? { success: false, error: error.message } : data;
            },
            async updateHeartbeat(userId) {
                await supabase.from('online_users').update({
                    last_seen: new Date().toISOString(), is_online: true
                }).eq('id', userId);
            },
            async setOffline(userId) {
                await supabase.from('online_users').update({
                    is_online: false, last_seen: new Date().toISOString()
                }).eq('id', userId);
            },
            async adminLogin(username, password) {
                const { data, error } = await supabase.rpc('admin_login', {
                    p_username: username, p_password: password
                });
                return error ? { success: false } : data;
            },
            async banUser(userId, banned) {
                const { error } = await supabase.rpc('ban_user', {
                    p_user_id: userId, p_banned: banned
                });
                return { success: !error };
            },
            async updateUserCoins(userId, coins) {
                const { error } = await supabase.rpc('admin_update_coins', {
                    p_user_id: userId, p_coins: coins
                });
                return { success: !error };
            },
            generateChatId(id1, id2) {
                return [id1, id2].sort().join('_');
            }
        };
        
        const { useState, useEffect, useRef } = React;
        
        // ==================== Â∑•ÂÖ∑ÂáΩÊï∞ ====================
        const getLocationFromIP = async () => {
          try {
            const response = await fetch('https://ipapi.co/json/', { mode: 'cors' });
            if (response.ok) {
              const data = await response.json();
              return data.city || data.region || data.country_name || 'Êú™Áü•Âú∞Âå∫';
            }
          } catch (error) {}
          const locations = ['Âåó‰∫¨', '‰∏äÊµ∑', 'ÂπøÂ∑û', 'Ê∑±Âú≥', 'Êù≠Â∑û', 'Âçó‰∫¨', 'ÊàêÈÉΩ', 'Ê≠¶Ê±â'];
          return locations[Math.floor(Math.random() * locations.length)];
        };
        
        const generateRandomUsername = () => {
          const adjectives = ['Âø´‰πêÁöÑ', 'Á•ûÁßòÁöÑ', 'ÂãáÊï¢ÁöÑ', 'Ê∏©ÊüîÁöÑ', 'ËÅ™ÊòéÁöÑ', 'Ê¥ªÊ≥ºÁöÑ', 'ÂÆâÈùôÁöÑ', 'ÂºÄÊúóÁöÑ'];
          const nouns = ['ÁÜäÁå´', 'ÁãêÁã∏', 'Â∞èÈπø', 'Â∞èÁå´', 'Â∞èÁãó', 'ÂÖîÂ≠ê', 'Êµ∑Ë±ö', '‰ºÅÈπÖ'];
          const num = Math.floor(Math.random() * 9999);
          return `${adjectives[Math.floor(Math.random() * adjectives.length)]}${nouns[Math.floor(Math.random() * nouns.length)]}${num}`;
        };
        
        const generateAvatarUrl = (seed) => {
          return `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}`;
        };
        
        const LocalSession = {
          get: () => JSON.parse(localStorage.getItem('current_session') || 'null'),
          save: (session) => localStorage.setItem('current_session', JSON.stringify(session)),
          clear: () => localStorage.removeItem('current_session')
        };
        
        const generateOrderId = () => {
          return `ORDER_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        };
        
        // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÊ≠£Á°ÆÊèêÂèñÂØπÊñπÁî®Êà∑ID
        const extractOtherUserId = (chatId, myUserId) => {
          const index = chatId.indexOf(myUserId);
          if (index === -1) return '';
          if (index === 0) {
            return chatId.substring(myUserId.length + 1);
          } else {
            return chatId.substring(0, index - 1);
          }
        };
        
        // ==================== ‰∏ªÂ∫îÁî® ====================
        const AnonymousChatApp = () => {
          const [currentUser, setCurrentUser] = useState(null);
          const [showLoginModal, setShowLoginModal] = useState(false);
          const [showRegisterModal, setShowRegisterModal] = useState(false);
          const [showCoinModal, setShowCoinModal] = useState(false);
          const [isConnected, setIsConnected] = useState(false);
          const heartbeatIntervalRef = useRef(null);
          
          useEffect(() => {
            setIsConnected(true); // Supabase always connected
            };
          }, []);
          
          useEffect(() => {
            if (currentUser && isConnected) {
              heartbeatIntervalRef.current = setInterval(() => {
                const userId = currentUser.id || currentUser.tempId;
                /* Converted to Supabase */.update({
                  lastSeen: Date.now(),
                  isOnline: true
                });
              }, 10000);
              
              return () => {
                if (heartbeatIntervalRef.current) {
                  clearInterval(heartbeatIntervalRef.current);
                }
              };
            }
          }, [currentUser, isConnected]);
          
          const checkPaymentCallback = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');
            const status = urlParams.get('status');
            
            if (orderId && status === 'success') {
              const orderData = JSON.parse(localStorage.getItem(orderId) || 'null');
              if (orderData) {
                handlePaymentSuccess(orderData);
                localStorage.removeItem(orderId);
                window.history.replaceState({}, document.title, window.location.pathname);
              }
            }
          };
          
          const handlePaymentSuccess = async (orderData) => {
            const session = LocalSession.get();
            if (session && !session.isTemp) {
              session.coins += orderData.coins;
              
              if (!session.rechargeHistory) {
                session.rechargeHistory = [];
              }
              session.rechargeHistory.push({
                coins: orderData.coins,
                amount: orderData.amount,
                timestamp: Date.now(),
                orderId: orderData.orderId
              });
              
              await /* Converted to Supabase */.update({
                coins: session.coins,
                rechargeHistory: session.rechargeHistory
              });
              
              LocalSession.save(session);
              setCurrentUser(session);
              
              alert(`ÂÖÖÂÄºÊàêÂäüÔºÅËé∑Âæó${orderData.coins}ÈáëÂ∏Å`);
            }
          };
          
          const initializeUser = async () => {
            let session = LocalSession.get();
            if (!session) {
              const gender = Math.random() > 0.5 ? 'male' : 'female';
              const tempId = `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
              const location = await getLocationFromIP();
              
              session = {
                tempId: tempId,
                username: generateRandomUsername(),
                gender: gender,
                avatarUrl: generateAvatarUrl(tempId),
                location: location,
                isTemp: true,
                coins: 0,
                createdAt: Date.now(),
                sentMessageCounts: {}
              };
              LocalSession.save(session);
            }
            
            if (!session.sentMessageCounts) {
              session.sentMessageCounts = {};
            }
            
            setCurrentUser(session);
            
            const userId = session.id || session.tempId;
            await /* Converted to Supabase */.set({
              ...session,
              isOnline: true,
              lastSeen: Date.now()
            });
          };
          
          const handleLogout = async () => {
            if (window.confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÂêóÔºü')) {
              const userId = currentUser.id || currentUser.tempId;
              await /* Converted to Supabase */.update({
                isOnline: false,
                lastSeen: Date.now()
              });
              LocalSession.clear();
              window.location.reload();
            }
          };
          
          const handleLogin = async (username, password) => {
            const usersSnapshot = await /* Converted to Supabase */.once('value');
            const usersData = usersSnapshot.val() || {};
            const user = Object.values(usersData).find(u => u.username === username && u.password === password);
            
            if (user) {
              if (!user.loginHistory) user.loginHistory = [];
              user.loginHistory.push({
                timestamp: Date.now(),
                location: currentUser.location
              });
              
              if (!user.sentMessageCounts) user.sentMessageCounts = {};
              
              await /* Converted to Supabase */.update(user);
              LocalSession.save(user);
              setCurrentUser(user);
              setShowLoginModal(false);
              
              await /* Converted to Supabase */.remove();
              await /* Converted to Supabase */.set({
                ...user,
                isOnline: true,
                lastSeen: Date.now()
              });
              
              alert('ÁôªÂΩïÊàêÂäüÔºÅ');
            } else {
              alert('Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØÔºÅ');
            }
          };
          
          // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÊ≥®ÂÜåÂπ∂‰øùÁïôËÅäÂ§©ËÆ∞ÂΩï
          const handleRegister = async (username, password) => {
            try {
              const usersSnapshot = await /* Converted to Supabase */.once('value');
              const usersData = usersSnapshot.val() || {};
              
              if (Object.values(usersData).find(u => u.username === username)) {
                alert('Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®ÔºÅ');
                return;
              }
              
              const keepChatHistory = username === currentUser.username;
              const oldTempId = currentUser.tempId;
              
              const newUser = {
                id: `user_${Date.now()}`,
                username,
                password,
                gender: currentUser.gender,
                avatarUrl: currentUser.avatarUrl,
                location: currentUser.location,
                isTemp: false,
                coins: 6,
                registeredAt: Date.now(),
                loginHistory: [{ timestamp: Date.now(), location: currentUser.location }],
                rechargeHistory: [],
                sentMessageCounts: keepChatHistory ? (currentUser.sentMessageCounts || {}) : {}
              };
              
              // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë‰øùÁïôËÅäÂ§©ËÆ∞ÂΩï
              if (keepChatHistory && oldTempId) {
                const chatsSnapshot = await /* Converted to Supabase */.once('value');
                const allChats = chatsSnapshot.val() || {};
                
                for (const [oldChatId, chatData] of Object.entries(allChats)) {
                  if (oldChatId.includes(oldTempId)) {
                    const otherUserId = extractOtherUserId(oldChatId, oldTempId);
                    if (!otherUserId) continue;
                    
                    const newChatId = [newUser.id, otherUserId].sort().join('_');
                    
                    const updatedMessages = {};
                    Object.entries(chatData).forEach(([msgId, msg]) => {
                      updatedMessages[msgId] = {
                        ...msg,
                        sender: msg.sender === oldTempId ? newUser.id : msg.sender
                      };
                    });
                    
                    await /* Converted to Supabase */.set(updatedMessages);
                    await /* Converted to Supabase */.remove();
                  }
                }
              }
              
              await /* Converted to Supabase */.set(newUser);
              await /* Converted to Supabase */.remove();
              await /* Converted to Supabase */.set({
                ...newUser,
                isOnline: true,
                lastSeen: Date.now()
              });
              
              LocalSession.save(newUser);
              setCurrentUser(newUser);
              setShowRegisterModal(false);
              
              alert(`Ê≥®ÂÜåÊàêÂäüÔºÅ${keepChatHistory ? 'Â∑≤‰øùÁïôËÅäÂ§©ËÆ∞ÂΩï„ÄÇ' : ''}Â∑≤Ëµ†ÈÄÅ6ÈáëÂ∏ÅÔºÅ`);
              setTimeout(() => window.location.reload(), 1000);
              
            } catch (error) {
              console.error('Ê≥®ÂÜåÈîôËØØ:', error);
              alert('Ê≥®ÂÜåÂ§±Ë¥•ÔºåËØ∑ÈáçËØïÔºÅ');
            }
          };
          
          if (!currentUser) {
            return (
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '100vh',
                color: 'white',
                fontSize: '20px',
                gap: '15px',
                padding: '20px'
              }}>
                <div style={{ fontSize: '40px' }}>üîÑ</div>
                <div>Ê≠£Âú®ÂàùÂßãÂåñ...</div>
              </div>
            );
          }
          
          return (
            <div className="app-container">
              <Header 
                currentUser={currentUser}
                isConnected={isConnected}
                onLogout={handleLogout}
                onShowLogin={() => setShowLoginModal(true)}
                onShowRegister={() => setShowRegisterModal(true)}
                onShowCoinModal={() => setShowCoinModal(true)}
              />
              
              <ChatView 
                currentUser={currentUser} 
                setCurrentUser={setCurrentUser}
                onShowRegister={() => setShowRegisterModal(true)}
              />
              
              {showLoginModal && (
                <LoginModal
                  onClose={() => setShowLoginModal(false)}
                  onLogin={handleLogin}
                />
              )}
              
              {showRegisterModal && (
                <RegisterModal
                  currentUsername={currentUser.username}
                  onClose={() => setShowRegisterModal(false)}
                  onRegister={handleRegister}
                />
              )}
              
              {showCoinModal && !currentUser.isTemp && (
                <CoinModal
                  currentUser={currentUser}
                  setCurrentUser={setCurrentUser}
                  onClose={() => setShowCoinModal(false)}
                />
              )}
            </div>
          );
        };
        
        // ==================== ÂõæÊ†áÁªÑ‰ª∂ ====================
        const MessageCircle = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
          </svg>
        );
        
        const Users = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="9" cy="7" r="4" />
            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
          </svg>
        );
        
        const Coins = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 6v6l4 2" />
          </svg>
        );
        
        const Send = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <line x1="22" y1="2" x2="11" y2="13" />
            <polygon points="22 2 15 22 11 13 2 9 22 2" />
          </svg>
        );
        
        const MapPin = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
            <circle cx="12" cy="10" r="3" />
          </svg>
        );
        
        const LogOut = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
            <polyline points="16 17 21 12 16 7" />
            <line x1="21" y1="12" x2="9" y2="12" />
          </svg>
        );
        
        const LogIn = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
            <polyline points="10 17 15 12 10 7" />
            <line x1="15" y1="12" x2="3" y2="12" />
          </svg>
        );
        
        const UserPlus = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
            <circle cx="8.5" cy="7" r="4" />
            <line x1="20" y1="8" x2="20" y2="14" />
            <line x1="23" y1="11" x2="17" y2="11" />
          </svg>
        );
        
        const X = ({ size = 24 }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        );
        
        // ==================== HeaderÁªÑ‰ª∂ ====================
        const Header = ({ currentUser, isConnected, onLogout, onShowLogin, onShowRegister, onShowCoinModal }) => {
          return (
            <div className="header">
              <div className="header-left">
                <div className="logo">
                  <MessageCircle size={window.innerWidth >= 768 ? 32 : 24} />
                  <span>ÂåøÂêçËÅäÂ§©</span>
                </div>
                <div className={`connection-status ${isConnected ? 'connected' : 'disconnected'}`}>
                  <span>{isConnected ? '‚óè Â∑≤ËøûÊé•' : '‚óè Êú™ËøûÊé•'}</span>
                </div>
              </div>
              <div className="header-right">
                <div className="user-info-card">
                  <img src={currentUser.avatarUrl} alt="avatar" className="user-avatar-img" />
                  <div className="user-info-text">
                    <div className="user-name">
                      {currentUser.username}
                      {currentUser.isTemp && <span className="temp-badge">‰∏¥Êó∂</span>}
                    </div>
                    <div className="user-meta">
                      <span className={currentUser.gender === 'male' ? 'gender-male' : 'gender-female'}>
                        {currentUser.gender === 'male' ? '‚ôÇ' : '‚ôÄ'}
                      </span>
                      <MapPin size={window.innerWidth >= 768 ? 12 : 10} />
                      <span>{currentUser.location}</span>
                    </div>
                  </div>
                </div>
                
                {!currentUser.isTemp && (
                  <div className="coins-badge" onClick={onShowCoinModal} title="ÁÇπÂáªÂÖÖÂÄº">
                    <Coins size={window.innerWidth >= 768 ? 16 : 14} />
                    <span>{currentUser.coins}</span>
                  </div>
                )}
                
                {currentUser.isTemp ? (
                  <>
                    <button className="btn btn-success" onClick={onShowRegister}>
                      <UserPlus size={window.innerWidth >= 768 ? 16 : 14} />
                      Ê≥®ÂÜå
                    </button>
                    <button className="btn btn-primary" onClick={onShowLogin}>
                      <LogIn size={window.innerWidth >= 768 ? 16 : 14} />
                      ÁôªÂΩï
                    </button>
                  </>
                ) : (
                  <button className="btn btn-danger" onClick={onLogout}>
                    <LogOut size={window.innerWidth >= 768 ? 16 : 14} />
                    ÈÄÄÂá∫
                  </button>
                )}
              </div>
            </div>
          );
        };
        
        // ==================== ChatViewÁªÑ‰ª∂ ====================
        const ChatView = ({ currentUser, setCurrentUser, onShowRegister }) => {
          const [onlineUsers, setOnlineUsers] = useState([]);
          const [selectedUser, setSelectedUser] = useState(null);
          const [messages, setMessages] = useState([]);
          const [inputMessage, setInputMessage] = useState('');
          const [isTyping, setIsTyping] = useState(false);
          const [unreadCounts, setUnreadCounts] = useState({});
          const messagesEndRef = useRef(null);
          const typingTimeoutRef = useRef(null);
          
          useEffect(() => {
            const onlineRef = /* Converted to Supabase */;
            const unsubscribe = onlineRef.on('value', (snapshot) => {
              const data = snapshot.val() || {};
              const currentUserId = currentUser.id || currentUser.tempId;
              const users = Object.values(data).filter(u => {
                const userId = u.id || u.tempId;
                return userId !== currentUserId;
              });
              setOnlineUsers(users);
            });
            
            return () => onlineRef.off('value', unsubscribe);
          }, [currentUser]);
          
          useEffect(() => {
            if (selectedUser) {
              const chatId = getChatId(currentUser, selectedUser);
              
              const messagesRef = /* Converted to Supabase */;
              const msgUnsubscribe = messagesRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                const msgs = Object.values(data).sort((a, b) => a.timestamp - b.timestamp);
                setMessages(msgs);
                
                const currentUserId = currentUser.id || currentUser.tempId;
                msgs.forEach(msg => {
                  if (msg.sender !== currentUserId && !msg.read) {
                    /* Converted to Supabase */.update({
                      read: true,
                      readAt: Date.now()
                    });
                  }
                });
                
                const otherUserId = selectedUser.id || selectedUser.tempId;
                setUnreadCounts(prev => {
                  const newCounts = { ...prev };
                  delete newCounts[otherUserId];
                  return newCounts;
                });
              });
              
              const typingRef = /* Converted to Supabase */;
              const typingUnsubscribe = typingRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                const otherUserId = selectedUser.id || selectedUser.tempId;
                setIsTyping(data[otherUserId] === true);
              });
              
              return () => {
                messagesRef.off('value', msgUnsubscribe);
                typingRef.off('value', typingUnsubscribe);
              };
            }
          }, [selectedUser, currentUser]);
          
          // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÁõëÂê¨Êú™ËØªÊ∂àÊÅØ
          useEffect(() => {
            const currentUserId = currentUser.id || currentUser.tempId;
            
            const chatsRef = /* Converted to Supabase */;
            const unreadListener = chatsRef.on('value', (snapshot) => {
              const allChats = snapshot.val() || {};
              const newUnreadCounts = {};
              
              Object.entries(allChats).forEach(([chatId, chatData]) => {
                if (chatId.includes(currentUserId)) {
                  const messages = Object.values(chatData || {});
                  const unreadMsgs = messages.filter(msg => 
                    msg.sender !== currentUserId && !msg.read
                  );
                  
                  if (unreadMsgs.length > 0) {
                    const otherUserId = extractOtherUserId(chatId, currentUserId);
                    if (otherUserId) {
                      newUnreadCounts[otherUserId] = unreadMsgs.length;
                    }
                  }
                }
              });
              
              setUnreadCounts(newUnreadCounts);
            });
            
            return () => {
              chatsRef.off('value', unreadListener);
            };
          }, [currentUser]);
          
          useEffect(() => {
            scrollToBottom();
          }, [messages]);
          
          const getChatId = (user1, user2) => {
            const id1 = user1.id || user1.tempId;
            const id2 = user2.id || user2.tempId;
            return [id1, id2].sort().join('_');
          };
          
          const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          };
          
          const handleInputChange = (e) => {
            setInputMessage(e.target.value);
            
            const chatId = getChatId(currentUser, selectedUser);
            const userId = currentUser.id || currentUser.tempId;
            /* Converted to Supabase */.set(true);
            
            if (typingTimeoutRef.current) {
              clearTimeout(typingTimeoutRef.current);
            }
            typingTimeoutRef.current = setTimeout(() => {
              /* Converted to Supabase */.remove();
            }, 3000);
          };
          
          const getSentMessageCount = (targetUserId) => {
            if (!currentUser.sentMessageCounts) return 0;
            return currentUser.sentMessageCounts[targetUserId] || 0;
          };
          
          const canSendMessage = () => {
            if (!selectedUser) return false;
            
            const targetUserId = selectedUser.id || selectedUser.tempId;
            const sentCount = getSentMessageCount(targetUserId);
            
            if (sentCount < 5) return true;
            if (currentUser.isTemp) return false;
            return currentUser.coins >= 2;
          };
          
          const handleSendMessage = async () => {
            if (!inputMessage.trim() || !selectedUser) return;
            
            const targetUserId = selectedUser.id || selectedUser.tempId;
            const sentCount = getSentMessageCount(targetUserId);
            
            if (sentCount >= 5 && currentUser.isTemp) {
              onShowRegister();
              return;
            }
            
            if (sentCount >= 5 && !currentUser.isTemp) {
              if (currentUser.coins < 2) {
                alert('ÈáëÂ∏Å‰∏çË∂≥ÔºåËØ∑ÂÖÖÂÄºÔºÅ');
                return;
              }
              currentUser.coins -= 2;
            }
            
            const chatId = getChatId(currentUser, selectedUser);
            const currentUserId = currentUser.id || currentUser.tempId;
            const newMessage = {
              id: `msg_${Date.now()}`,
              sender: currentUserId,
              text: inputMessage,
              timestamp: Date.now(),
              read: false
            };
            
            await /* Converted to Supabase */.set(newMessage);
            await /* Converted to Supabase */.remove();
            
            if (!currentUser.sentMessageCounts) {
              currentUser.sentMessageCounts = {};
            }
            currentUser.sentMessageCounts[targetUserId] = sentCount + 1;
            
            if (!currentUser.isTemp) {
              await /* Converted to Supabase */.update({
                coins: currentUser.coins,
                sentMessageCounts: currentUser.sentMessageCounts
              });
            }
            
            LocalSession.save(currentUser);
            setCurrentUser({ ...currentUser });
            setInputMessage('');
          };
          
          const getMessageLimitText = () => {
            if (!selectedUser) return '';
            
            const targetUserId = selectedUser.id || selectedUser.tempId;
            const sentCount = getSentMessageCount(targetUserId);
            
            if (sentCount >= 5) {
              if (currentUser.isTemp) {
                return `Â∑≤ÂêëËØ•Áî®Êà∑ÂèëÈÄÅ${sentCount}Êù°Ê∂àÊÅØÔºåÈúÄË¶ÅÊ≥®ÂÜåÊâçËÉΩÁªßÁª≠`;
              } else {
                return `ÂêëËØ•Áî®Êà∑ÔºöÊØèÊù°2ÈáëÂ∏ÅÔºàÂâ©‰Ωô${currentUser.coins}ÈáëÂ∏ÅÔºâ`;
              }
            } else {
              return `ÂêëËØ•Áî®Êà∑ÔºöËøòÂèØÂÖçË¥πÂèëÈÄÅ ${5 - sentCount} Êù°Ê∂àÊÅØ`;
            }
          };
          
          return (
            <div className="main-content">
              {/* Áî®Êà∑ÂàóË°® - Á¥ßÂáëÂûã */}
              <div className="sidebar">
                <div className="sidebar-title">
                  <Users size={window.innerWidth >= 768 ? 18 : 16} /> 
                  Âú®Á∫ø ({onlineUsers.length})
                </div>
                <div className="user-grid">
                  {onlineUsers.map(user => {
                    const userId = user.id || user.tempId;
                    const unreadCount = unreadCounts[userId] || 0;
                    
                    return (
                      <div
                        key={userId}
                        className={`user-card ${selectedUser && ((selectedUser.id && selectedUser.id === user.id) || (selectedUser.tempId && selectedUser.tempId === user.tempId)) ? 'active' : ''}`}
                        onClick={() => setSelectedUser(user)}
                      >
                        <div className="user-card-avatar-wrapper">
                          <img src={user.avatarUrl} alt={user.username} className="user-card-avatar" />
                          {user.isOnline && <div className="online-dot" />}
                          {unreadCount > 0 && (
                            <div className="unread-badge">{unreadCount > 9 ? '9+' : unreadCount}</div>
                          )}
                        </div>
                        <div className="user-card-info">
                          <div className="user-card-name">{user.username}</div>
                          <div className="user-card-meta">
                            <span style={{ 
                              color: user.gender === 'male' ? '#4A90E2' : '#FF69B4',
                              fontWeight: 'bold'
                            }}>
                              {user.gender === 'male' ? '‚ôÇ' : '‚ôÄ'}
                            </span>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
              
              {/* ËÅäÂ§©Âå∫Âüü */}
              <div className="chat-area">
                {selectedUser ? (
                  <>
                    <div className="chat-header">
                      <h2>{selectedUser.username}</h2>
                      <div style={{ fontSize: window.innerWidth >= 768 ? '14px' : '12px', opacity: 0.9, marginTop: '5px' }}>
                        {selectedUser.gender === 'male' ? '‚ôÇ' : '‚ôÄ'} ¬∑ {selectedUser.location} ¬∑ 
                        {selectedUser.isOnline ? ' Âú®Á∫ø' : ' Á¶ªÁ∫ø'}
                        {!selectedUser.isTemp && ' ¬∑ Ê≥®ÂÜåÁî®Êà∑'}
                      </div>
                    </div>
                    
                    <div className="chat-messages">
                      {messages.length === 0 ? (
                        <div className="empty-state">
                          <MessageCircle size={window.innerWidth >= 768 ? 60 : 50} />
                          <p>ÊöÇÊó†Ê∂àÊÅØÔºåÂºÄÂßãËÅäÂ§©ÂêßÔºÅ</p>
                        </div>
                      ) : (
                        messages.map((msg) => {
                          const isOwn = msg.sender === (currentUser.id || currentUser.tempId);
                          const avatar = isOwn ? currentUser.avatarUrl : selectedUser.avatarUrl;
                          
                          return (
                            <div key={msg.id} className={`message ${isOwn ? 'own' : ''}`}>
                              <img src={avatar} alt="avatar" className="message-avatar-img" />
                              <div className="message-content">
                                <div className="message-bubble">{msg.text}</div>
                                <div className="message-time">
                                  {new Date(msg.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}
                                  {isOwn && msg.read && ' ¬∑ Â∑≤ËØª'}
                                </div>
                              </div>
                            </div>
                          );
                        })
                      )}
                      
                      {isTyping && (
                        <div className="typing-indicator">
                          <span>ÂØπÊñπÊ≠£Âú®ËæìÂÖ•</span>
                          <div className="typing-dots">
                            <div className="typing-dot"></div>
                            <div className="typing-dot"></div>
                            <div className="typing-dot"></div>
                          </div>
                        </div>
                      )}
                      
                      <div ref={messagesEndRef} />
                    </div>
                    
                    <div className="chat-input-container">
                      <div className="message-limit-info">
                        <span>{getMessageLimitText()}</span>
                      </div>
                      <div className="chat-input-wrapper">
                        <input
                          type="text"
                          className="chat-input"
                          placeholder={canSendMessage() ? "ËæìÂÖ•Ê∂àÊÅØ..." : "Ê∂àÊÅØÈ¢ùÂ∫¶Â∑≤Áî®ÂÆå"}
                          value={inputMessage}
                          onChange={handleInputChange}
                          onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                          disabled={!canSendMessage()}
                        />
                        <button 
                          className="send-btn" 
                          onClick={handleSendMessage}
                          disabled={!canSendMessage() || !inputMessage.trim()}
                        >
                          <Send size={window.innerWidth >= 768 ? 20 : 18} />
                        </button>
                      </div>
                    </div>
                  </>
                ) : (
                  <div className="empty-state">
                    <Users size={window.innerWidth >= 768 ? 80 : 60} />
                    <h3 style={{ fontSize: window.innerWidth >= 768 ? '20px' : '16px' }}>ËØ∑ÈÄâÊã©‰∏Ä‰∏™Áî®Êà∑ÂºÄÂßãËÅäÂ§©</h3>
                    <p style={{ fontSize: window.innerWidth >= 768 ? '14px' : '12px' }}>‰ªé{window.innerWidth >= 768 ? 'Â∑¶‰æß' : '‰∏äÊñπ'}Áî®Êà∑ÂàóË°®‰∏≠ÈÄâÊã©</p>
                  </div>
                )}
              </div>
            </div>
          );
        };
        
        // ==================== Ê®°ÊÄÅÊ°ÜÁªÑ‰ª∂ ====================
        const LoginModal = ({ onClose, onLogin }) => {
          const [username, setUsername] = useState('');
          const [password, setPassword] = useState('');
          
          return (
            <div className="modal-overlay" onClick={onClose}>
              <div className="modal" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <h2 className="modal-title">Áî®Êà∑ÁôªÂΩï</h2>
                  <button className="close-btn" onClick={onClose}><X size={20} /></button>
                </div>
                <div className="form-group">
                  <label className="form-label">Áî®Êà∑Âêç</label>
                  <input
                    type="text"
                    className="form-input"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">ÂØÜÁ†Å</label>
                  <input
                    type="password"
                    className="form-input"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å"
                    onKeyPress={(e) => e.key === 'Enter' && onLogin(username, password)}
                  />
                </div>
                <button className="btn btn-primary" style={{ width: '100%' }} onClick={() => onLogin(username, password)}>
                  <LogIn size={16} /> ÁôªÂΩï
                </button>
              </div>
            </div>
          );
        };
        
        const RegisterModal = ({ currentUsername, onClose, onRegister }) => {
          const [username, setUsername] = useState(currentUsername);
          const [password, setPassword] = useState('');
          const [confirmPassword, setConfirmPassword] = useState('');
          
          const handleSubmit = () => {
            if (!username || !password) {
              alert('ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØÔºÅ');
              return;
            }
            if (password !== confirmPassword) {
              alert('‰∏§Ê¨°ÂØÜÁ†Å‰∏ç‰∏ÄËá¥ÔºÅ');
              return;
            }
            if (password.length < 6) {
              alert('ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë6‰ΩçÔºÅ');
              return;
            }
            onRegister(username, password);
          };
          
          return (
            <div className="modal-overlay" onClick={onClose}>
              <div className="modal" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <h2 className="modal-title">Áî®Êà∑Ê≥®ÂÜå</h2>
                  <button className="close-btn" onClick={onClose}><X size={20} /></button>
                </div>
                <div className="form-warning">
                  ‚ö†Ô∏è ÊèêÁ§∫Ôºö‰ΩøÁî®ÂΩìÂâçÁî®Êà∑Âêç"{currentUsername}"Ê≥®ÂÜåÔºåÂ∞Ü‰øùÁïôËÅäÂ§©ËÆ∞ÂΩïÔºÅ
                </div>
                <div className="form-group">
                  <label className="form-label">Áî®Êà∑Âêç</label>
                  <input
                    type="text"
                    className="form-input"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    placeholder="ËæìÂÖ•Áî®Êà∑Âêç"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">ÂØÜÁ†Å</label>
                  <input
                    type="password"
                    className="form-input"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="ËæìÂÖ•ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Á°ÆËÆ§ÂØÜÁ†Å</label>
                  <input
                    type="password"
                    className="form-input"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    placeholder="ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å"
                    onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
                  />
                </div>
                <button className="btn btn-primary" style={{ width: '100%' }} onClick={handleSubmit}>
                  <UserPlus size={16} /> Á´ãÂç≥Ê≥®ÂÜåÔºàËµ†ÈÄÅ6ÈáëÂ∏ÅÔºâ
                </button>
              </div>
            </div>
          );
        };
        
        const CoinModal = ({ currentUser, setCurrentUser, onClose }) => {
          const packages = [
            { coins: 300, price: 3 },
            { coins: 600, price: 5 },
            { coins: 1500, price: 10 }
          ];
          
          const handleSelectPackage = (pkg) => {
            const orderId = generateOrderId();
            
            const orderData = {
              orderId: orderId,
              coins: pkg.coins,
              amount: pkg.price,
              userId: currentUser.id,
              timestamp: Date.now()
            };
            localStorage.setItem(orderId, JSON.stringify(orderData));
            
            const callbackUrl = `${window.location.origin}${window.location.pathname}?orderId=${orderId}&status=success`;
            const paymentUrl = PAYMENT_URLS[pkg.coins] + orderId + `&callback=${encodeURIComponent(callbackUrl)}`;
            
            if (confirm(`Á°ÆËÆ§ÊîØ‰ªò¬•${pkg.price}Ë¥≠‰π∞${pkg.coins}ÈáëÂ∏ÅÔºü`)) {
              window.location.href = paymentUrl;
            }
          };
          
          return (
            <div className="modal-overlay" onClick={onClose}>
              <div className="modal" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <h2 className="modal-title">Ë¥≠‰π∞ÈáëÂ∏Å</h2>
                  <button className="close-btn" onClick={onClose}><X size={20} /></button>
                </div>
                <div style={{ 
                  marginBottom: window.innerWidth >= 768 ? '20px' : '15px',
                  padding: window.innerWidth >= 768 ? '15px' : '12px',
                  background: '#e7f3ff',
                  borderRadius: window.innerWidth >= 768 ? '10px' : '8px',
                  fontSize: window.innerWidth >= 768 ? '14px' : '12px'
                }}>
                  <strong>ÂΩìÂâçÈáëÂ∏ÅÔºö</strong>{currentUser.coins} üí∞
                </div>
                <div className="coin-packages">
                  {packages.map((pkg, index) => (
                    <div
                      key={index}
                      className="coin-package"
                      onClick={() => handleSelectPackage(pkg)}
                    >
                      <div className="coin-package-info">
                        <div className="coin-icon">üí∞</div>
                        <div className="coin-details">
                          <h3>{pkg.coins} ÈáëÂ∏Å</h3>
                          <p>ÂèØÂèëÈÄÅ {pkg.coins / 2} Êù°Ê∂àÊÅØ</p>
                        </div>
                      </div>
                      <div className="coin-price">¬•{pkg.price}</div>
                    </div>
                  ))}
                </div>
                <div style={{ 
                  fontSize: window.innerWidth >= 768 ? '13px' : '11px',
                  color: '#6c757d',
                  textAlign: 'center',
                  marginTop: window.innerWidth >= 768 ? '10px' : '8px'
                }}>
                  * ÁÇπÂáªÂ•óÈ§êË∑≥ËΩ¨Âà∞ÊîØ‰ªòÈ°µÈù¢
                </div>
              </div>
            </div>
          );
        };
        
        // ==================== Ê∏≤Êüì ====================
        ReactDOM.createRoot(document.getElementById('root')).render(<AnonymousChatApp />);
    </script>
</body>
</html>
