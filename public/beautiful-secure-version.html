<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ¿åèŠå¤©ç³»ç»Ÿ - å®‰å…¨ç‰ˆ</title>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- bcryptå¯†ç åŠ å¯† -->
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* å¤´éƒ¨ */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid #667eea;
            object-fit: cover;
        }

        .coin-badge {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        /* ä¸»ä½“åŒºåŸŸ - å“åº”å¼ */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            padding: 10px;
            gap: 10px;
        }

        /* æ¡Œé¢ç«¯å¸ƒå±€ */
        @media (min-width: 769px) {
            .main-content {
                flex-direction: row;
            }

            .user-list-container {
                width: 280px;
                flex-shrink: 0;
            }

            .chat-container {
                flex: 1;
            }
        }

        /* æ‰‹æœº/å¹³æ¿ç«¯å¸ƒå±€ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .user-list-container {
                height: 35vh;
                width: 100%;
            }

            .chat-container {
                flex: 1;
            }
        }

        /* ç”¨æˆ·åˆ—è¡¨ */
        .user-list-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .user-list-header {
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-grid {
            display: grid;
            gap: 10px;
            padding: 15px;
            overflow-y: auto;
        }

        /* æ¡Œé¢ç«¯ï¼šç«–å‘æ’åˆ— */
        @media (min-width: 769px) {
            .user-grid {
                grid-template-columns: 1fr;
            }
        }

        /* æ‰‹æœºç«¯ï¼šæ¨ªå‘ç½‘æ ¼ */
        @media (max-width: 768px) {
            .user-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }

        .user-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .user-card {
                flex-direction: column;
                text-align: center;
                padding: 10px 5px;
            }
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .user-card.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .user-card .avatar {
            flex-shrink: 0;
        }

        .user-card-info {
            flex: 1;
            min-width: 0;
        }

        @media (max-width: 768px) {
            .user-card-info {
                width: 100%;
            }
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-location {
            font-size: 12px;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .online-badge {
            width: 10px;
            height: 10px;
            background: #00ff00;
            border-radius: 50%;
            position: absolute;
            top: 8px;
            right: 8px;
            box-shadow: 0 0 6px #00ff00;
        }

        .unread-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff4757;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message .avatar {
            width: 36px;
            height: 36px;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 60%;
        }

        .message-bubble {
            padding: 10px 15px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            word-wrap: break-word;
        }

        .message.own .message-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message.own .message-time {
            flex-direction: row-reverse;
            color: rgba(255,255,255,0.7);
        }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-container {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.1);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            font-size: 14px;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: #667eea;
        }

        .gender-selector {
            display: flex;
            gap: 10px;
        }

        .gender-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .gender-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
            color: #667eea;
        }

        .package-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .package-card {
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .package-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .package-card.popular {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .package-coins {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .package-price {
            font-size: 18px;
            color: #999;
            margin-top: 5px;
        }

        .popular-badge {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ========== Supabaseé…ç½® ==========
        const SUPABASE_URL = 'https://jekcgyklvptniqdhgtbe.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impla2NneWtsdnB0bmlxZGhndGJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NDY3NjEsImV4cCI6MjA4NzQyMjc2MX0.mtlOeZmEyXqSZnxsGg0zbAlFr_IPYSbmYl8mYvJAfHw';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ========== ä¸»åº”ç”¨ ==========
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [onlineUsers, setOnlineUsers] = useState([]);
            const [selectedUser, setSelectedUser] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [sending, setSending] = useState(false);
            const [showRegisterModal, setShowRegisterModal] = useState(false);
            const [showCoinModal, setShowCoinModal] = useState(false);
            const [unreadCounts, setUnreadCounts] = useState({});
            const messagesEndRef = useRef(null);

            // åˆå§‹åŒ–ç”¨æˆ·
            useEffect(() => {
                initUser();
            }, []);

            // åˆå§‹åŒ–ç”¨æˆ·
            const initUser = async () => {
                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    // å·²ç™»å½•ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
                    const { data } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();
                    
                    setCurrentUser(data);
                    updateOnlineStatus(data.id, true);
                } else {
                    // åˆ›å»ºä¸´æ—¶ç”¨æˆ·
                    createTempUser();
                }
            };

            // åˆ›å»ºä¸´æ—¶ç”¨æˆ·
            const createTempUser = async () => {
                const randomNum = Math.floor(Math.random() * 9999);
                const gender = Math.random() > 0.5 ? 'male' : 'female';
                
                const tempUser = {
                    tempId: `temp_${Date.now()}`,
                    id: `temp_${Date.now()}`,
                    username: `æ¸¸å®¢${randomNum}`,
                    gender: gender,
                    avatarUrl: `https://api.dicebear.com/7.x/avataaars/svg?seed=${randomNum}`,
                    location: await getLocationFromIP(),
                    isTemp: true,
                    coins: 0
                };
                
                setCurrentUser(tempUser);
                localStorage.setItem('tempUser', JSON.stringify(tempUser));
            };

            // è·å–IPä½ç½®
            const getLocationFromIP = async () => {
                const apis = [
                    'https://ipapi.co/json/',
                    'https://ip-api.com/json/',
                    'https://ipinfo.io/json'
                ];
                
                for (const api of apis) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        
                        const response = await fetch(api, {
                            signal: controller.signal,
                            mode: 'cors'
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            const data = await response.json();
                            return data.city || data.region || data.country || 'æœªçŸ¥';
                        }
                    } catch (error) {
                        console.log(`${api} å¤±è´¥`);
                    }
                }
                
                const locations = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'æˆéƒ½'];
                return locations[Math.floor(Math.random() * locations.length)];
            };

            // æ›´æ–°åœ¨çº¿çŠ¶æ€
            const updateOnlineStatus = async (userId, isOnline) => {
                if (!userId || userId.startsWith('temp_')) return;
                
                try {
                    await supabase
                        .from('online_users')
                        .upsert({
                            id: userId,
                            is_online: isOnline,
                            last_seen: new Date().toISOString()
                        });
                } catch (error) {
                    console.error('æ›´æ–°åœ¨çº¿çŠ¶æ€å¤±è´¥:', error);
                }
            };

            // è·å–åœ¨çº¿ç”¨æˆ·
            useEffect(() => {
                if (!currentUser) return;

                const fetchOnlineUsers = async () => {
                    try {
                        const { data } = await supabase
                            .from('online_users')
                            .select(`
                                *,
                                users (
                                    id,
                                    username,
                                    gender,
                                    avatar_url,
                                    location
                                )
                            `)
                            .eq('is_online', true);

                        const users = (data || [])
                            .filter(u => u.users && u.id !== currentUser.id)
                            .map(u => ({
                                ...u.users,
                                avatarUrl: u.users.avatar_url
                            }));

                        setOnlineUsers(users);
                    } catch (error) {
                        console.error('è·å–åœ¨çº¿ç”¨æˆ·å¤±è´¥:', error);
                        // æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
                        setOnlineUsers([
                            {
                                id: '1',
                                username: 'å°æ˜',
                                gender: 'male',
                                avatarUrl: 'https://api.dicebear.com/7.x/avataaars/svg?seed=ming',
                                location: 'åŒ—äº¬'
                            },
                            {
                                id: '2',
                                username: 'å°çº¢',
                                gender: 'female',
                                avatarUrl: 'https://api.dicebear.com/7.x/avataaars/svg?seed=hong',
                                location: 'ä¸Šæµ·'
                            }
                        ]);
                    }
                };

                fetchOnlineUsers();

                // è®¢é˜…åœ¨çº¿çŠ¶æ€å˜åŒ–
                const subscription = supabase
                    .from('online_users')
                    .on('*', () => {
                        fetchOnlineUsers();
                    })
                    .subscribe();

                return () => {
                    subscription.unsubscribe();
                };
            }, [currentUser]);

            // è·å–èŠå¤©æ¶ˆæ¯
            useEffect(() => {
                if (!currentUser || !selectedUser) return;

                const chatId = [currentUser.id, selectedUser.id].sort().join('_');

                const loadMessages = async () => {
                    try {
                        const { data } = await supabase
                            .from('messages')
                            .select('*')
                            .eq('chat_id', chatId)
                            .order('created_at', { ascending: true });

                        setMessages(data || []);
                        
                        // æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
                        markMessagesAsRead(data || []);
                    } catch (error) {
                        console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
                    }
                };

                loadMessages();

                // è®¢é˜…æ–°æ¶ˆæ¯
                const subscription = supabase
                    .from('messages')
                    .on('INSERT', (payload) => {
                        if (payload.new.chat_id === chatId) {
                            setMessages(prev => [...prev, payload.new]);
                            
                            if (payload.new.receiver_id === currentUser.id) {
                                markMessageAsRead(payload.new.id);
                            }
                        }
                    })
                    .subscribe();

                return () => {
                    subscription.unsubscribe();
                };
            }, [currentUser, selectedUser]);

            // æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
            const markMessagesAsRead = async (messages) => {
                const unreadMessages = messages.filter(
                    m => m.receiver_id === currentUser.id && !m.read
                );

                for (const msg of unreadMessages) {
                    await markMessageAsRead(msg.id);
                }
            };

            const markMessageAsRead = async (messageId) => {
                try {
                    await supabase
                        .from('messages')
                        .update({
                            read: true,
                            read_at: new Date().toISOString()
                        })
                        .eq('id', messageId);
                } catch (error) {
                    console.error('æ ‡è®°å·²è¯»å¤±è´¥:', error);
                }
            };

            // æ»šåŠ¨åˆ°åº•éƒ¨
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // å‘é€æ¶ˆæ¯
            const handleSendMessage = async () => {
                if (!inputMessage.trim() || sending) return;

                setSending(true);

                try {
                    // è°ƒç”¨Edge Functionå‘é€æ¶ˆæ¯
                    const { data, error } = await supabase.functions.invoke('send-message', {
                        body: {
                            targetUserId: selectedUser.id,
                            text: inputMessage
                        }
                    });

                    if (error) throw error;

                    if (data.success) {
                        setInputMessage('');
                        
                        // æ›´æ–°é‡‘å¸
                        if (data.coinsDeducted > 0) {
                            setCurrentUser(prev => ({
                                ...prev,
                                coins: data.remainingCoins
                            }));
                        }
                    }
                } catch (error) {
                    console.error('å‘é€å¤±è´¥:', error);
                    
                    if (error.message.includes('TEMP_USER_LIMIT')) {
                        setShowRegisterModal(true);
                    } else if (error.message.includes('INSUFFICIENT_COINS')) {
                        setShowCoinModal(true);
                    } else {
                        alert('å‘é€å¤±è´¥ï¼š' + error.message);
                    }
                } finally {
                    setSending(false);
                }
            };

            // æ³¨å†Œ
            const handleRegister = async (username, password) => {
                try {
                    const passwordHash = await bcrypt.hash(password, 10);
                    
                    const { data, error } = await supabase.functions.invoke('register-user', {
                        body: {
                            username,
                            passwordHash,
                            tempId: currentUser?.tempId,
                            tempData: currentUser
                        }
                    });

                    if (error) throw error;

                    alert('æ³¨å†ŒæˆåŠŸï¼å·²èµ é€6é‡‘å¸');
                    setShowRegisterModal(false);
                    
                    // åˆ·æ–°é¡µé¢é‡æ–°ç™»å½•
                    window.location.reload();
                } catch (error) {
                    alert('æ³¨å†Œå¤±è´¥ï¼š' + error.message);
                }
            };

            if (!currentUser) {
                return <div style={{padding: '40px', textAlign: 'center', color: 'white'}}>æ­£åœ¨åŠ è½½...</div>;
            }

            return (
                <div className="app-container">
                    <Header 
                        currentUser={currentUser} 
                        onRegister={() => setShowRegisterModal(true)}
                        onBuyCoins={() => setShowCoinModal(true)}
                    />
                    
                    <div className="main-content">
                        <UserList
                            users={onlineUsers}
                            selectedUser={selectedUser}
                            onSelectUser={setSelectedUser}
                            unreadCounts={unreadCounts}
                        />
                        
                        <ChatArea
                            currentUser={currentUser}
                            selectedUser={selectedUser}
                            messages={messages}
                            inputMessage={inputMessage}
                            sending={sending}
                            onInputChange={setInputMessage}
                            onSend={handleSendMessage}
                            messagesEndRef={messagesEndRef}
                        />
                    </div>

                    {showRegisterModal && (
                        <RegisterModal
                            onClose={() => setShowRegisterModal(false)}
                            onRegister={handleRegister}
                        />
                    )}

                    {showCoinModal && (
                        <CoinModal
                            onClose={() => setShowCoinModal(false)}
                        />
                    )}
                </div>
            );
        }

        // ========== å¤´éƒ¨ç»„ä»¶ ==========
        function Header({ currentUser, onRegister, onBuyCoins }) {
            return (
                <div className="header">
                    <div className="logo">
                        ğŸ’¬ åŒ¿åèŠå¤©
                    </div>
                    <div className="user-info">
                        <img src={currentUser.avatarUrl} alt="avatar" className="avatar" />
                        <span style={{fontWeight: 600}}>{currentUser.username}</span>
                        {!currentUser.isTemp && (
                            <div className="coin-badge" onClick={onBuyCoins} style={{cursor: 'pointer'}}>
                                ğŸª™ {currentUser.coins}
                            </div>
                        )}
                        {currentUser.isTemp && (
                            <button className="btn btn-primary" onClick={onRegister}>
                                æ³¨å†Œ
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        // ========== ç”¨æˆ·åˆ—è¡¨ç»„ä»¶ ==========
        function UserList({ users, selectedUser, onSelectUser, unreadCounts }) {
            return (
                <div className="user-list-container">
                    <div className="user-list-header">
                        <span>åœ¨çº¿ç”¨æˆ·</span>
                        <span>{users.length}</span>
                    </div>
                    <div className="user-grid">
                        {users.map(user => (
                            <div
                                key={user.id}
                                className={`user-card ${selectedUser?.id === user.id ? 'active' : ''}`}
                                onClick={() => onSelectUser(user)}
                            >
                                <img src={user.avatarUrl} alt={user.username} className="avatar" />
                                <div className="user-card-info">
                                    <div className="user-name">{user.username}</div>
                                    <div className="user-location">{user.location}</div>
                                </div>
                                {unreadCounts[user.id] > 0 && (
                                    <div className="unread-badge">{unreadCounts[user.id]}</div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ========== èŠå¤©åŒºåŸŸç»„ä»¶ ==========
        function ChatArea({ currentUser, selectedUser, messages, inputMessage, sending, onInputChange, onSend, messagesEndRef }) {
            if (!selectedUser) {
                return (
                    <div className="chat-container">
                        <div className="empty-state">
                            <div style={{fontSize: '48px', marginBottom: '20px'}}>ğŸ’¬</div>
                            <div style={{fontSize: '18px', fontWeight: 600, marginBottom: '10px'}}>
                                é€‰æ‹©ä¸€ä¸ªç”¨æˆ·å¼€å§‹èŠå¤©
                            </div>
                            <div style={{fontSize: '14px'}}>
                                ç‚¹å‡»å·¦ä¾§ç”¨æˆ·åˆ—è¡¨ä¸­çš„ä»»æ„ç”¨æˆ·
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="chat-container">
                    <div className="chat-header">
                        <div className="chat-header-info">
                            <img src={selectedUser.avatarUrl} alt={selectedUser.username} className="avatar" />
                            <div>
                                <div style={{fontWeight: 600}}>{selectedUser.username}</div>
                                <div style={{fontSize: '12px', opacity: 0.8}}>{selectedUser.location}</div>
                            </div>
                        </div>
                    </div>

                    <div className="chat-messages">
                        {messages.length === 0 ? (
                            <div className="empty-state">
                                <div style={{fontSize: '36px', marginBottom: '15px'}}>ğŸ‘‹</div>
                                <div>æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹èŠå¤©å§ï¼</div>
                            </div>
                        ) : (
                            messages.map(msg => (
                                <div
                                    key={msg.id}
                                    className={`message ${msg.sender_id === currentUser.id ? 'own' : ''}`}
                                >
                                    <img
                                        src={msg.sender_id === currentUser.id ? currentUser.avatarUrl : selectedUser.avatarUrl}
                                        alt="avatar"
                                        className="avatar"
                                    />
                                    <div className="message-content">
                                        <div className="message-bubble">{msg.text}</div>
                                        <div className="message-time">
                                            {new Date(msg.created_at).toLocaleTimeString('zh-CN', {
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}
                                            {msg.sender_id === currentUser.id && (
                                                <span>{msg.read ? 'âœ“âœ“' : 'âœ“'}</span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    <div className="chat-input-container">
                        <input
                            type="text"
                            className="chat-input"
                            placeholder="è¾“å…¥æ¶ˆæ¯..."
                            value={inputMessage}
                            onChange={(e) => onInputChange(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && onSend()}
                            disabled={sending}
                        />
                        <button
                            className="send-btn"
                            onClick={onSend}
                            disabled={sending || !inputMessage.trim()}
                        >
                            {sending ? <span className="loading"></span> : 'â¤'}
                        </button>
                    </div>
                </div>
            );
        }

        // ========== æ³¨å†Œæ¨¡æ€æ¡† ==========
        function RegisterModal({ onClose, onRegister }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async () => {
                if (!username || !password) {
                    alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                    return;
                }

                if (username.length < 2 || username.length > 20) {
                    alert('ç”¨æˆ·åé•¿åº¦åº”åœ¨2-20ä½ä¹‹é—´');
                    return;
                }

                if (password.length < 6) {
                    alert('å¯†ç è‡³å°‘6ä½');
                    return;
                }

                setLoading(true);
                await onRegister(username, password);
                setLoading(false);
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-title">æ³¨å†Œè´¦å·</div>
                        <div style={{color: '#666', marginBottom: '20px', fontSize: '14px'}}>
                            æ³¨å†Œå³å¯ä¿ç•™èŠå¤©è®°å½•ï¼Œå¹¶è·å¾—6é‡‘å¸å¥–åŠ±ï¼
                        </div>

                        <div className="form-group">
                            <label className="form-label">ç”¨æˆ·å</label>
                            <input
                                type="text"
                                className="form-input"
                                placeholder="2-20ä½ï¼Œä¸­æ–‡/å­—æ¯/æ•°å­—"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                            />
                        </div>

                        <div className="form-group">
                            <label className="form-label">å¯†ç </label>
                            <input
                                type="password"
                                className="form-input"
                                placeholder="è‡³å°‘6ä½"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                            />
                        </div>

                        <div style={{display: 'flex', gap: '10px', marginTop: '25px'}}>
                            <button
                                className="btn btn-outline"
                                onClick={onClose}
                                style={{flex: 1}}
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                className="btn btn-primary"
                                onClick={handleSubmit}
                                disabled={loading}
                                style={{flex: 1}}
                            >
                                {loading ? <span className="loading"></span> : 'æ³¨å†Œ'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ========== å……å€¼æ¨¡æ€æ¡† ==========
        function CoinModal({ onClose }) {
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-title">è´­ä¹°é‡‘å¸</div>
                        <div style={{color: '#666', marginBottom: '10px', fontSize: '14px'}}>
                            é‡‘å¸ç”¨äºå‘é€æ¶ˆæ¯ï¼ˆè¶…è¿‡å…è´¹é¢åº¦åï¼‰
                        </div>

                        <div className="package-grid">
                            <div className="package-card">
                                <div className="package-coins">300 ğŸª™</div>
                                <div className="package-price">Â¥3</div>
                            </div>
                            <div className="package-card popular">
                                <div className="popular-badge">æœ€å—æ¬¢è¿</div>
                                <div className="package-coins">600 ğŸª™</div>
                                <div className="package-price">Â¥5</div>
                            </div>
                            <div className="package-card">
                                <div className="package-coins">1500 ğŸª™</div>
                                <div className="package-price">Â¥10</div>
                            </div>
                        </div>

                        <div style={{marginTop: '20px', padding: '15px', background: '#f8f9fa', borderRadius: '10px', fontSize: '13px', color: '#666'}}>
                            ğŸ’¡ æç¤ºï¼šæ³¨å†Œç”¨æˆ·æ¯äººä¸æ¯ä¸ªç”¨æˆ·å‰5æ¡æ¶ˆæ¯å…è´¹ï¼Œä¹‹åæ¯æ¡æ¶ˆæ¯æ¶ˆè€—2é‡‘å¸
                        </div>

                        <button
                            className="btn btn-outline"
                            onClick={onClose}
                            style={{width: '100%', marginTop: '20px'}}
                        >
                            å…³é—­
                        </button>
                    </div>
                </div>
            );
        }

        // ========== æ¸²æŸ“åº”ç”¨ ==========
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
